<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imóveis | Instituto Valentis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAHklEQVQ4T2NkYGBgYGBkZGRkZGSkZGTkZGRkZAQAOK4G/B8z8/gAAAAASUVORK5CYII=">
    <style>
        body { background-color: #f8f9fa; padding: 15px; font-family: 'Arial', sans-serif; }
        .container { max-width: 100%; }
        h1, h2 { font-size: 1.8rem; text-align: center; margin-bottom: 20px; }
        h2 { font-size: 1.5rem; }
        .property-card { border: none; border-radius: 12px; background: #fff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 15px; margin-bottom: 20px; transition: transform 0.2s; }
        .property-card:hover { transform: translateY(-5px); }
        .carousel img { height: 200px; object-fit: cover; border-radius: 8px; cursor: pointer; }
        .carousel-control-prev, .carousel-control-next { width: 10%; background: rgba(0, 0, 0, 0.3); }
        .form-section { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin-top: 30px; }
        .form-control, .form-select { height: 48px; font-size: 1rem; margin-bottom: 10px; }
        textarea.form-control { height: 100px; }
        .btn-primary { height: 50px; font-size: 1.1rem; border-radius: 8px; }
        .alert { margin-top: 15px; border-radius: 8px; font-size: 1rem; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fullscreen-carousel img { max-height: 80vh; width: auto; margin: auto; object-fit: contain; }
        .modal-fullscreen .modal-dialog { max-width: 100%; margin: 0; }
        .modal-fullscreen .modal-content { border: none; border-radius: 0; background: rgba(0, 0, 0, 0.9); }
        .no-properties { text-align: center; color: #6c757d; margin-top: 20px; font-size: 1rem; }
        @media (max-width: 576px) {
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.2rem; }
            .property-card { padding: 10px; }
            .carousel img { height: 150px; }
            .form-control, .form-select { font-size: 0.9rem; }
            .btn-primary { font-size: 1rem; }
            .fullscreen-carousel img { max-height: 70vh; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Imóveis em Ivatuba</h1>
        <div id="properties-list" class="row"></div>
        <div class="form-section">
            <h2>Cadastrar Novo Imóvel</h2>
            <form id="property-form">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="owner" class="form-label">Nome do Proprietário</label>
                        <input type="text" class="form-control" id="owner" required>
                    </div>
                    <div class="col-12">
                        <label for="type" class="form-label">Tipo</label>
                        <select class="form-select" id="type" required>
                            <option value="locacao">Locação</option>
                            <option value="venda">Venda</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="value" class="form-label">Valor (R$)</label>
                        <input type="number" class="form-control" id="value" step="0.01" required>
                    </div>
                    <div class="col-12">
                        <label for="description" class="form-label">Descrição</label>
                        <textarea class="form-control" id="description" required></textarea>
                    </div>
                    <div class="col-6">
                        <label for="bedrooms" class="form-label">Quartos</label>
                        <input type="number" class="form-control" id="bedrooms" required>
                    </div>
                    <div class="col-6">
                        <label for="suites" class="form-label">Suítes</label>
                        <input type="number" class="form-control" id="suites" required>
                    </div>
                    <div class="col-6">
                        <label for="livingrooms" class="form-label">Salas</label>
                        <input type="number" class="form-control" id="livingrooms" required>
                    </div>
                    <div class="col-6">
                        <label for="kitchens" class="form-label">Cozinhas</label>
                        <input type="number" class="form-control" id="kitchens" required>
                    </div>
                    <div class="col-6">
                        <label for="bathrooms" class="form-label">Banheiros</label>
                        <input type="number" class="form-control" id="bathrooms" required>
                    </div>
                    <div class="col-6">
                        <label for="garage" class="form-label">Garagem</label>
                        <select class="form-select" id="garage" required>
                            <option value="sim">Sim</option>
                            <option value="nao">Não</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label for="garage-spaces" class="form-label">Vagas na Garagem</label>
                        <input type="number" class="form-control" id="garage-spaces" disabled>
                    </div>
                    <div class="col-12">
                        <label for="email" class="form-label">E-mail de Contato</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="col-12">
                        <label for="phone" class="form-label">Telefone de Contato</label>
                        <input type="tel" class="form-control" id="phone" required>
                    </div>
                    <div class="col-12">
                        <label for="address" class="form-label">Endereço</label>
                        <input type="text" class="form-control" id="address" required>
                    </div>
                    <div class="col-6">
                        <label for="area" class="form-label">Área (m²)</label>
                        <input type="number" class="form-control" id="area" step="0.01" required>
                    </div>
                    <div class="col-6">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" required>
                            <option value="disponivel">Disponível</option>
                            <option value="vendido">Vendido</option>
                            <option value="alugado">Alugado</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="photos" class="form-label">Fotos do Imóvel (máximo 15)</label>
                        <input type="file" class="form-control" id="photos" accept="image/*" multiple>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary w-100">Cadastrar Imóvel</button>
                    </div>
                </div>
            </form>
            <div id="form-feedback" class="alert" style="display: none;"></div>
        </div>
    </div>

    <div class="modal fade modal-fullscreen" id="fullscreenCarouselModal" tabindex="-1" aria-labelledby="fullscreenCarouselModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="fullscreen-carousel" class="carousel slide">
                        <div class="carousel-inner" id="fullscreen-carousel-inner"></div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#fullscreen-carousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#fullscreen-carousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const JSONBIN_API_KEY = '$2a$10$dKijF5oFCYh5pYskkUvbPO9WziVB5PTwj8H7KI2D3nbUhzp7Zivwu'; // Substitua pela Master Key
        const JSONBIN_URL = 'https://api.jsonbin.io/v3/b/67ffa03c8960c979a58666af'; // Substitua pelo Bin ID
        const IMGBB_API_KEY = '9023917c56a250f28edf8bc7f1ba5632'; // Substitua pela nova chave ImgBB

        let properties = [];

        async function loadProperties() {
            try {
                const response = await fetch(JSONBIN_URL, {
                    headers: { 'X-Master-Key': JSONBIN_API_KEY }
                });
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const data = await response.json();
                properties = data.record || [];
                console.log('Imóveis carregados:', properties);
                displayProperties();
            } catch (error) {
                console.error('Erro ao carregar imóveis:', error);
                alert(`Erro ao carregar imóveis: ${error.message}. Verifique a conexão ou as credenciais.`);
                properties = [];
                displayProperties();
            }
        }

        async function saveProperties() {
            try {
                if (properties.length > 5) {
                    properties = properties.slice(-5);
                }
                await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(properties)
                });
                console.log('Imóveis salvos:', properties);
            } catch (error) {
                console.error('Erro ao salvar imóveis:', error);
                alert(`Erro ao salvar imóveis: ${error.message}.`);
            }
        }

        function displayProperties() {
            const propertiesList = document.getElementById('properties-list');
            propertiesList.innerHTML = '';
            const approvedProperties = properties.filter(p => p.approvalStatus === 'approved');
            console.log('Imóveis aprovados:', approvedProperties);

            if (approvedProperties.length === 0) {
                propertiesList.innerHTML = '<p class="no-properties">Nenhum imóvel aprovado disponível. Acesse o painel administrativo para aprovar.</p>';
                return;
            }

            approvedProperties.forEach((property, index) => {
                const photosHtml = property.photos && property.photos.length > 0
                    ? `
                        <div id="carousel-${index}" class="carousel slide">
                            <div class="carousel-inner">
                                ${property.photos.map((photo, i) => `
                                    <div class="carousel-item ${i === 0 ? 'active' : ''}">
                                        <img src="${photo}" class="d-block w-100" alt="Foto do imóvel" onclick="openFullscreenCarousel(${index}, ${i})">
                                    </div>
                                `).join('')}
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#carousel-${index}" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carousel-${index}" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    `
                    : '<p class="text-muted">Sem fotos disponíveis</p>';

                const card = `
                    <div class="col-12">
                        <div class="property-card">
                            ${photosHtml}
                            <h3 class="mt-3">${property.owner || 'Proprietário não informado'}</h3>
                            <p><strong>Status:</strong> ${typeof property.status === 'string' && property.status ? property.status.charAt(0).toUpperCase() + property.status.slice(1) : 'Indefinido'}</p>
                            <p><strong>Tipo:</strong> ${property.type === 'locacao' ? 'Locação' : 'Venda'}</p>
                            <p><strong>Valor:</strong> R$ ${property.value ? parseFloat(property.value).toFixed(2) : '0.00'}</p>
                            <details>
                                <summary>Mais Detalhes</summary>
                                <p><strong>Descrição:</strong> ${property.description || 'Sem descrição'}</p>
                                <p><strong>Quartos:</strong> ${property.bedrooms || 0}</p>
                                <p><strong>Suítes:</strong> ${property.suites || 0}</p>
                                <p><strong>Salas:</strong> ${property.livingrooms || 0}</p>
                                <p><strong>Cozinhas:</strong> ${property.kitchens || 0}</p>
                                <p><strong>Banheiros:</strong> ${property.bathrooms || 0}</p>
                                <p><strong>Garagem:</strong> ${property.garage === 'sim' ? `Sim (${property.garageSpaces || 0} vagas)` : 'Não'}</p>
                                <p><strong>Contato:</strong> ${property.email || 'N/A'} | ${property.phone || 'N/A'}</p>
                                <p><strong>Endereço:</strong> ${property.address || 'Não informado'}</p>
                                <p><strong>Área:</strong> ${property.area || 0} m²</p>
                                <p><strong>Data de Publicação:</strong> ${property.date || 'N/A'}</p>
                            </details>
                        </div>
                    </div>
                `;
                propertiesList.innerHTML += card;
            });
        }

        function openFullscreenCarousel(propertyIndex, startIndex) {
            const approvedProperties = properties.filter(p => p.approvalStatus === 'approved');
            const property = approvedProperties[propertyIndex];
            if (!property || !property.photos) {
                alert('Erro: Imóvel não encontrado ou sem fotos.');
                return;
            }
            const carouselInner = document.getElementById('fullscreen-carousel-inner');
            carouselInner.innerHTML = property.photos.map((photo, i) => `
                <div class="carousel-item ${i === startIndex ? 'active' : ''}">
                    <img src="${photo}" class="fullscreen-carousel" alt="Foto do imóvel">
                </div>
            `).join('');
            new bootstrap.Modal(document.getElementById('fullscreenCarouselModal')).show();
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let width = img.width;
                        let height = img.height;
                        const maxDim = 1024;
                        if (width > height && width > maxDim) {
                            height *= maxDim / width;
                            width = maxDim;
                        } else if (height > maxDim) {
                            width *= maxDim / height;
                            height = maxDim;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.7);
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        async function uploadToImgBB(file) {
            try {
                const formData = new FormData();
                formData.append('image', file);
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const data = await response.json();
                if (data.success) {
                    return data.data.url;
                }
                return null;
            } catch (error) {
                console.error('Erro ao fazer upload da imagem:', error);
                return null;
            }
        }

        async function handlePhotos(files) {
            const compressedFiles = await Promise.all([...files].slice(0, 15).map(file => compressImage(file)));
            const urls = await Promise.all(compressedFiles.map(file => uploadToImgBB(file)));
            return urls.filter(url => url !== null);
        }

        function getLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve({ latitude: null, longitude: null });
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        });
                    },
                    () => {
                        resolve({ latitude: null, longitude: null });
                    }
                );
            });
        }

        window.onload = () => {
            loadProperties();
        };

        document.getElementById('property-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const feedback = document.getElementById('form-feedback');
            const garage = document.getElementById('garage').value;
            const photos = document.getElementById('photos').files;

            if (photos.length > 15) {
                feedback.innerHTML = 'Erro: Você pode enviar no máximo 15 imagens.';
                feedback.className = 'alert alert-danger';
                feedback.style.display = 'block';
                setTimeout(() => feedback.style.display = 'none', 5000);
                return;
            }

            try {
                const photoUrls = await handlePhotos(photos);
                const location = await getLocation();

                const property = {
                    owner: document.getElementById('owner').value,
                    type: document.getElementById('type').value,
                    value: document.getElementById('value').value,
                    description: document.getElementById('description').value,
                    bedrooms: document.getElementById('bedrooms').value,
                    suites: document.getElementById('suites').value,
                    livingrooms: document.getElementById('livingrooms').value,
                    kitchens: document.getElementById('kitchens').value,
                    bathrooms: document.getElementById('bathrooms').value,
                    garage: garage,
                    garageSpaces: garage === 'sim' ? document.getElementById('garage-spaces').value : 0,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    area: document.getElementById('area').value,
                    status: document.getElementById('status').value,
                    date: new Date().toLocaleDateString('pt-BR'),
                    photos: photoUrls,
                    approvalStatus: 'pending',
                    latitude: location.latitude,
                    longitude: location.longitude
                };

                properties.push(property);
                if (properties.length > 5) {
                    properties = properties.slice(-5);
                }

                await saveProperties();
                displayProperties();
                document.getElementById('property-form').reset();
                document.getElementById('garage-spaces').disabled = true;

                feedback.innerHTML = 'Imóvel cadastrado com sucesso! Aguardando aprovação do administrador.';
                feedback.className = 'alert alert-success';
                feedback.style.display = 'block';
                setTimeout(() => feedback.style.display = 'none', 5000);
            } catch (error) {
                console.error('Erro ao cadastrar imóvel:', error);
                feedback.innerHTML = 'Erro ao cadastrar imóvel. Verifique a conexão ou os dados.';
                feedback.className = 'alert alert-danger';
                feedback.style.display = 'block';
                document.getElementById('property-form').reset();
                document.getElementById('garage-spaces').disabled = true;
                setTimeout(() => feedback.style.display = 'none', 5000);
            }
        });

        document.getElementById('garage').addEventListener('change', (e) => {
            const garageSpaces = document.getElementById('garage-spaces');
            garageSpaces.disabled = e.target.value === 'nao';
            if (e.target.value === 'nao') garageSpaces.value = '';
        });
    </script>
</body>
</html>