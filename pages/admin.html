<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo | Instituto Valentis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAHklEQVQ4T2NkYGBgYGBkZGRkZGSkZGTkZGRkZAQAOK4G/B8z8/gAAAAASUVORK5CYII=">
    <style>
        body { background-color: #f8f9fa; padding: 15px; font-family: 'Arial', sans-serif; }
        .container { max-width: 100%; }
        h1 { font-size: 1.8rem; text-align: center; margin-bottom: 20px; }
        .auth-section, .admin-section { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .form-control { height: 48px; font-size: 1rem; }
        .btn-primary, .btn-danger, .btn-success { height: 50px; font-size: 1.1rem; border-radius: 8px; }
        .property-card { border: none; border-radius: 12px; background: #fff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 15px; margin-bottom: 20px; }
        .carousel img { height: 200px; object-fit: cover; border-radius: 8px; }
        .alert { margin-top: 15px; border-radius: 8px; }
        .location-list li { margin-bottom: 10px; }
        @media (max-width: 576px) {
            h1 { font-size: 1.5rem; }
            .property-card { padding: 10px; }
            .carousel img { height: 150px; }
            .btn-primary, .btn-danger, .btn-success { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Painel Administrativo</h1>
        <div id="auth-section" class="auth-section">
            <form id="auth-form">
                <div class="mb-3">
                    <label for="password" class="form-label">Senha</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Entrar</button>
            </form>
            <div id="auth-feedback" class="alert" style="display: none;"></div>
        </div>
        <div id="admin-section" class="admin-section" style="display: none;">
            <button id="clear-data" class="btn btn-danger w-100 mb-3">Limpar Todos os Dados</button>
            <h2>Imóveis Cadastrados</h2>
            <div id="properties-list" class="row"></div>
            <h2>Localizações de Acesso</h2>
            <ul id="location-list" class="location-list"></ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const JSONBIN_API_KEY = '$2a$10$jLB8GrHbXG7GX5Vjdtw3UO6R0yOFTlgxXKmdtj1ey1X0L.u5F44Ly'; // Mesma chave do solucoes.html
        const JSONBIN_URL = 'https://api.jsonbin.io/v3/b/67fecacceb52f179214af0fd'; // Mesmo bin ID
        const ADMIN_PASSWORD = 'admin123';
        let properties = [];
        let accessLocations = [];

        // Carrega dados do JSONBin
        async function loadData() {
            try {
                const response = await fetch(JSONBIN_URL, {
                    headers: { 'X-Master-Key': JSONBIN_API_KEY }
                });
                const data = await response.json();
                properties = data.record || [];
                accessLocations = properties
                    .filter(p => p.latitude && p.longitude)
                    .map(p => ({
                        latitude: p.latitude,
                        longitude: p.longitude,
                        timestamp: p.date
                    }));
                console.log('Dados carregados:', properties, accessLocations);
                if (document.getElementById('admin-section').style.display === 'block') {
                    displayProperties();
                    displayLocations();
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showFeedback('Erro ao carregar dados.', 'danger');
            }
        }

        // Salva dados no JSONBin
        async function saveData() {
            try {
                await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(properties)
                });
                console.log('Dados salvos:', properties);
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                showFeedback('Erro ao salvar dados.', 'danger');
            }
        }

        // Exibe feedback
        function showFeedback(message, type) {
            const feedback = document.getElementById('auth-feedback');
            feedback.innerHTML = message;
            feedback.className = `alert alert-${type}`;
            feedback.style.display = 'block';
            setTimeout(() => feedback.style.display = 'none', 5000);
        }

        // Exibe imóveis
        function displayProperties() {
            const propertiesList = document.getElementById('properties-list');
            propertiesList.innerHTML = '';
            if (properties.length === 0) {
                propertiesList.innerHTML = '<p class="text-muted">Nenhum imóvel cadastrado.</p>';
                return;
            }
            properties.forEach((property, index) => {
                const photosHtml = property.photos && property.photos.length > 0
                    ? `
                        <div id="carousel-admin-${index}" class="carousel slide">
                            <div class="carousel-inner">
                                ${property.photos.map((photo, i) => `
                                    <div class="carousel-item ${i === 0 ? 'active' : ''}">
                                        <img src="${photo}" class="d-block w-100" alt="Foto do imóvel">
                                    </div>
                                `).join('')}
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#carousel-admin-${index}" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carousel-admin-${index}" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    `
                    : '<p class="text-muted">Sem fotos disponíveis</p>';

                const approveButton = property.approvalStatus !== 'approved'
                    ? `<button class="btn btn-success w-100 mt-2 approve-btn" data-index="${index}">Aprovar</button>`
                    : '';

                const card = `
                    <div class="col-12">
                        <div class="property-card">
                            ${photosHtml}
                            <h3 class="mt-3">${property.owner || 'Proprietário não informado'}</h3>
                            <p><strong>Status:</strong> ${property.approvalStatus === 'approved' ? 'Aprovado' : 'Pendente'}</p>
                            <p><strong>Tipo:</strong> ${property.type === 'locacao' ? 'Locação' : 'Venda'}</p>
                            <p><strong>Valor:</strong> R$ ${property.value ? parseFloat(property.value).toFixed(2) : '0.00'}</p>
                            <details>
                                <summary>Mais Detalhes</summary>
                                <p><strong>Descrição:</strong> ${property.description || 'Sem descrição'}</p>
                                <p><strong>Quartos:</strong> ${property.bedrooms || 0}</p>
                                <p><strong>Suítes:</strong> ${property.suites || 0}</p>
                                <p><strong>Salas:</strong> ${property.livingrooms || 0}</p>
                                <p><strong>Cozinhas:</strong> ${property.kitchens || 0}</p>
                                <p><strong>Banheiros:</strong> ${property.bathrooms || 0}</p>
                                <p><strong>Garagem:</strong> ${property.garage === 'sim' ? `Sim (${property.garageSpaces || 0} vagas)` : 'Não'}</p>
                                <p><strong>Contato:</strong> ${property.email || 'N/A'} | ${property.phone || 'N/A'}</p>
                                <p><strong>Endereço:</strong> ${property.address || 'Não informado'}</p>
                                <p><strong>Área:</strong> ${property.area || 0} m²</p>
                                <p><strong>Data:</strong> ${property.date || 'N/A'}</p>
                                <p><strong>Localização:</strong> ${property.latitude && property.longitude ? `Lat: ${property.latitude}, Lon: ${property.longitude}` : 'Não disponível'}</p>
                            </details>
                            ${approveButton}
                        </div>
                    </div>
                `;
                propertiesList.innerHTML += card;
            });

            document.querySelectorAll('.approve-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const index = e.target.dataset.index;
                    properties[index].approvalStatus = 'approved';
                    await saveData();
                    displayProperties();
                    showFeedback('Imóvel aprovado com sucesso!', 'success');
                });
            });
        }

        // Exibe localizações
        function displayLocations() {
            const locationList = document.getElementById('location-list');
            locationList.innerHTML = '';
            if (accessLocations.length === 0) {
                locationList.innerHTML = '<li class="text-muted">Nenhuma localização registrada.</li>';
                return;
            }
            accessLocations.forEach(loc => {
                locationList.innerHTML += `<li>Lat: ${loc.latitude}, Lon: ${loc.longitude}, Data: ${loc.timestamp}</li>`;
            });
        }

        // Autenticação
        document.getElementById('auth-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('admin-section').style.display = 'block';
                displayProperties();
                displayLocations();
            } else {
                showFeedback('Senha incorreta.', 'danger');
            }
        });

        // Limpa dados
        document.getElementById('clear-data').addEventListener('click', async () => {
            if (confirm('Tem certeza que deseja limpar todos os dados?')) {
                properties = [];
                accessLocations = [];
                await saveData();
                displayProperties();
                displayLocations();
                showFeedback('Todos os dados foram limpos.', 'success');
            }
        });

        // Carrega dados ao iniciar
        loadData();
    </script>
</body>
</html>